<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Private Bin</title>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

<div class="max-w-3xl w-full">

  <h1 class="text-3xl font-bold mb-6 text-center">My Private Bin</h1>

  <div id="createArea" class="bg-white shadow rounded p-6 mb-6">
    <label class="block mb-2 font-semibold">Title (optional)</label>
    <input id="title" class="w-full border rounded p-2 mb-4"/>

    <label class="block mb-2 font-semibold">Content</label>
    <textarea id="content" class="w-full border rounded p-2 h-48 mb-4"></textarea>

    <label class="block mb-2 font-semibold">Password (optional)</label>
    <input id="password" type="password" class="w-full border rounded p-2 mb-4"/>

    <label class="block mb-2 font-semibold">One-time view?</label>
    <input id="oneTime" type="checkbox" class="mb-4"/>

    <button id="createBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Create Link</button>
  </div>

  <div id="result" class="mb-6"></div>

  <div id="viewArea" class="bg-white shadow rounded p-6 hidden">
    <h2 id="viewTitle" class="text-xl font-bold mb-4"></h2>
    <pre><code id="viewContent" class="language-none"></code></pre>
    <p id="note" class="text-red-600 mt-4 font-semibold"></p>
  </div>

</div>

<script>
// ===== Helpers =====
async function encryptContent(text, password) {
  const enc = new TextEncoder();
  const data = enc.encode(text);
  const key = await crypto.subtle.importKey('raw', enc.encode(password), 'AES-GCM', false, ['encrypt']);
  const iv = enc.encode('0123456789ABCDEF');
  const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
  return btoa(String.fromCharCode(...new Uint8Array(cipher)));
}

async function decryptContent(ciphertext, password) {
  const enc = new TextEncoder();
  const data = Uint8Array.from(atob(ciphertext), c=>c.charCodeAt(0));
  const key = await crypto.subtle.importKey('raw', enc.encode(password), 'AES-GCM', false, ['decrypt']);
  const iv = enc.encode('0123456789ABCDEF');
  const decrypted = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data);
  return new TextDecoder().decode(decrypted);
}

// ===== Handle Create =====
document.getElementById('createBtn').addEventListener('click', async () => {
  const title = document.getElementById('title').value || '';
  const content = document.getElementById('content').value;
  const password = document.getElementById('password').value;
  const oneTime = document.getElementById('oneTime').checked;

  if(!content) return alert('Content required!');

  let encoded;
  if(password) encoded = await encryptContent(content, password);
  else encoded = btoa(content);

  const url = `${location.origin}${location.pathname}#${encodeURIComponent(encoded)}|${encodeURIComponent(title)}|${password ? 1 : 0}|${oneTime ? 1 : 0}`;
  document.getElementById('result').innerHTML = `
    <p class="text-green-700 font-semibold">Link Created:</p>
    <a href="${url}" target="_blank" class="text-blue-600 underline break-all">${url}</a>
    <p class="text-gray-500 mt-2">One-time view: ${oneTime ? 'Yes' : 'No'}</p>
  `;
});

// ===== Handle Viewing =====
async function loadFromHash() {
  if(location.hash){
    const [encoded, title, isEncrypted, oneTimeFlag] = decodeURIComponent(location.hash.slice(1)).split('|');
    const storageKey = `viewed_${encoded}`;
    const alreadyViewed = localStorage.getItem(storageKey);

    if(oneTimeFlag==='1' && alreadyViewed){
      alert('This one-time link has already been viewed!');
      return;
    }

    let content;
    if(isEncrypted==='1'){
      const password = prompt('Enter password to view:');
      try { content = await decryptContent(encoded, password); }
      catch(e){ content='Invalid password or corrupted data'; }
    } else content = atob(encoded);

    // Show content
    document.getElementById('viewTitle').innerText = title || 'Untitled';
    const codeElem = document.getElementById('viewContent');
    codeElem.textContent = content;
    Prism.highlightElement(codeElem);

    document.getElementById('createArea').style.display='none';
    document.getElementById('result').style.display='none';
    document.getElementById('viewArea').classList.remove('hidden');

    // Mark as viewed if one-time
    if(oneTimeFlag==='1') localStorage.setItem(storageKey,'true');

    if(oneTimeFlag==='1') document.getElementById('note').innerText = 'Note: This was a one-time view paste.';
  }
}

window.addEventListener('load', loadFromHash);
</script>

</body>
</html>

