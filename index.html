<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Private Bin</title>

<style>
body { font-family: Arial, sans-serif; margin: 2rem; max-width: 700px; }
textarea { width: 100%; height: 200px; margin-top: 0.5em; }
input, button { padding: 0.6em; margin-top: 0.5em; }
pre { background: #f4f4f4; padding: 1em; border: 1px solid #ddd; white-space: pre-wrap; }
#result a { word-break: break-all; }
</style>
</head>
<body>

<h1>My Private Bin</h1>

<!-- Create section -->
<div id="createBox">
    <label>Title:</label><br>
    <input id="title"><br><br>

    <label>Content:</label><br>
    <textarea id="content"></textarea><br>

    <label>Password (optional):</label><br>
    <input id="password" type="password"><br>

    <button id="createBtn">Create Link</button>

    <div id="result" style="margin-top: 1rem;"></div>
</div>

<!-- View section -->
<div id="viewBox" style="display:none;"></div>

<script>
// Simple encryption using AES-GCM with proper random IV
async function encrypt(text, password) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
    );
    
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const key = await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt"]
    );

    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encrypted = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        enc.encode(text)
    );

    return btoa(JSON.stringify({
        ct: Array.from(new Uint8Array(encrypted)),
        iv: Array.from(iv),
        salt: Array.from(salt)
    }));
}

async function decrypt(data, password) {
    const json = JSON.parse(atob(data));
    const enc = new TextEncoder();

    const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
    );
    
    const key = await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt: new Uint8Array(json.salt), iterations: 100000, hash: "SHA-256" },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["decrypt"]
    );

    const decrypted = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv: new Uint8Array(json.iv) },
        key,
        new Uint8Array(json.ct)
    );

    return new TextDecoder().decode(decrypted);
}

// Create Link Button
document.getElementById("createBtn").onclick = async () => {
    const title = document.getElementById("title").value || "Untitled";
    const content = document.getElementById("content").value;
    const password = document.getElementById("password").value;

    if (!content) return alert("Please enter content!");

    let encoded;
    let encrypted = 0;

    if (password) {
        encoded = await encrypt(content, password);
        encrypted = 1;
    } else {
        encoded = btoa(content);
    }

    const link =
        `${location.origin}${location.pathname}#${encoded}|${encodeURIComponent(title)}|${encrypted}`;

    document.getElementById("result").innerHTML =
        `<p><strong>Your Link:</strong><br><a href="${link}" target="_blank">${link}</a></p>`;
};

// Load paste if URL hash exists
window.onload = async () => {
    if (location.hash.length > 1) {
        const hash = location.hash.substring(1);
        const [encoded, title, encrypted] = hash.split("|");

        let content;

        if (encrypted === "1") {
            const password = prompt("Enter password to view the content:");
            try {
                content = await decrypt(encoded, password);
            } catch {
                content = "‚ùå Wrong password or corrupted content";
            }
        } else {
            content = atob(encoded);
        }

        document.getElementById("viewBox").innerHTML =
            `<h2>${decodeURIComponent(title)}</h2><pre>${content}</pre>`;

        document.getElementById("viewBox").style.display = "block";
        document.getElementById("createBox").style.display = "none";
    }
};
</script>

</body>
</html>
